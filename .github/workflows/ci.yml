name: CI Pipeline

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  # Validate before running expensive operations
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Verify dependencies
        run: go mod verify

  # Unit tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.txt
          flags: unittests

      # NEW: Print coverage summary
      - name: Coverage summary
        run: |
          go tool cover -func=coverage.txt | tail -1
          COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"

          # Fail if coverage drops below threshold (optional)
          # Uncomment to enforce minimum coverage
          # if (( $(echo "$COVERAGE < 60" | bc -l) )); then
          #   echo "Coverage below 60% threshold"
          #   exit 1
          # fi

  # Linting
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - uses: golangci/golangci-lint-action@v9  # âœ… Latest
        with:
          version: v2.6.2
          args: --timeout=5m
          # Fix: Skip config verification to avoid CI environment issues
          skip-pkg-cache: true
          # Use local config file path relative to workspace
          config: .golangci.yml

  # Integration tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      # Compile integration tests to catch errors
      - name: Compile integration tests
        run: go test -tags=integration -run=XXX_NO_MATCH_XXX ./...

      - name: Run integration tests
        run: go test -tags=integration -v ./...

  # Build verification
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build CLI
        run: go build -v -o bin/cli ./cmd/cli

      - name: Build Web
        run: go build -v -o bin/web ./cmd/web

  # Docker build (only on push)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployments/docker/Dockerfile
          push: false
          tags: telos-matrix:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker build -f deployments/docker/Dockerfile -t telos-matrix:test .
          docker run --rm telos-matrix:test --help